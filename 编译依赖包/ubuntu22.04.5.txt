# 1. æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…æ‰€æœ‰ç¼–è¯‘ä¾èµ–
sudo apt update && sudo apt install -y \
    git-core gnupg flex bison build-essential zip curl \
    zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
    lib32ncurses5-dev lib32z1-dev lib32stdc++6 \
    x11proto-core-dev libx11-dev libgl1-mesa-dev libxml2-utils \
    xsltproc unzip fontconfig python3 python3-pip python3-venv \
    python3-distutils bc bison ccache curl flex g++-multilib \
    gcc-multilib git gnupg gperf imagemagick lib32readline-dev \
    libbz2-dev libc6-dev libcurl4-openssl-dev libelf-dev libffi-dev \
    libfreetype6-dev liblz4-dev liblzo2-dev libncurses5-dev \
    libncursesw5-dev libpng-dev libsdl1.2-dev libssl-dev libtinfo5 \
    libtool libxml2 libxml2-dev lzop m4 ncurses-dev openjdk-17-jdk \
    patch pkg-config rsync subversion texinfo wget xz-utils zlib1g-dev \
    libgl1 libgl1-mesa-glx libgl1-mesa-dri

# 2. é…ç½® ccacheï¼ˆåŠ é€Ÿé‡å¤ç¼–è¯‘ï¼‰
echo 'export USE_CCACHE=1' >> ~/.bashrc
ccache -M 50G 2>/dev/null || true

# 3. å‡çº§ç”¨æˆ·çº§ pipï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
python3 -m pip install --user --upgrade pip

# 4. å¢å¤§ inotify ç›‘è§†æ•°ï¼ˆé˜²æ­¢ repo sync æŠ¥é”™ï¼‰
echo 'fs.inotify.max_user_watches=524288' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# 5. éªŒè¯ Java ç‰ˆæœ¬ï¼ˆç¡®ä¿æ˜¯ OpenJDK 17ï¼‰
echo "âœ… Java version:"
java -version 2>&1 | head -n 2

# 6. æç¤ºç”¨æˆ·é‡æ–°åŠ è½½ shellï¼ˆå¯é€‰ï¼‰
echo -e "\nğŸ‰ ç¯å¢ƒé…ç½®å®Œæˆï¼å»ºè®®æ‰§è¡Œï¼š\n   source ~/.bashrc\næˆ–æ‰“å¼€æ–°ç»ˆç«¯ä»¥å¯ç”¨ ccacheã€‚"





æ³¨æ„ç¼–è¯‘æ—¶è¦é€€å‡ºcondaç¯å¢ƒï¼š
conda deactivate
# å¦‚æœè¿˜æœ‰ (base) æç¤ºï¼Œå¯èƒ½éœ€è¦è¿è¡Œå¤šæ¬¡ï¼Œç›´åˆ° (base) æ¶ˆå¤±

æ³¨æ„ï¼š
ç”¨ubuntuåŸç”Ÿç‰ˆæœ¬è€ŒésdkåŸå§‹ç‰ˆæœ¬çš„ç¼–è¯‘è¦å…ˆå‡çº§sdkçš„å…³é”®åŒ…ï¼ˆç¡¬åˆš 22.04ï¼‰
å¦‚æœä½ åšæŒè¦åœ¨æœ¬æœº Ubuntu 22.04 ä¸Šç¼–è¯‘ï¼Œé‚£ä¹ˆåœ¨é‡æ–°è§£å‹ SDK ä¹‹åã€è¿è¡Œ build.sh ä¹‹å‰ï¼Œè¯·å…ˆæ‰§è¡Œä»¥ä¸‹å‡ ä¸ªâ€œé¢„å¤„ç†â€æ­¥éª¤ã€‚åšå®Œè¿™ä¸‰æ­¥ï¼Œèƒ½é¿å¼€ 99% çš„å‘ã€‚
ç›´æ¥å‡çº§ host-fakeroot (æœ€å…³é”®)
è¿™æ˜¯å¯¼è‡´ä½ æœ€åæ‰“åŒ…å¤±è´¥çš„å…ƒå‡¶ã€‚æ—§ç‰ˆ fakeroot æ— æ³•åœ¨æ–° Linux å†…æ ¸/Glibc ä¸Šè¿è¡Œã€‚
ç¼–è¾‘æ–‡ä»¶ï¼šbuildroot/package/fakeroot/fakeroot.mk
ä¿®æ”¹ç‰ˆæœ¬å·å’Œç¯å¢ƒï¼š
å°†ï¼šfakeroot.mkæ”¹æˆä»¥ä¸‹ï¼š
################################################################################
#
# fakeroot
#
################################################################################

FAKEROOT_VERSION = 1.32.1
FAKEROOT_SOURCE = fakeroot_$(FAKEROOT_VERSION).orig.tar.gz
# ä½ çš„æœ¬åœ°å·²ç»æœ‰æ–‡ä»¶äº†ï¼Œè¿™ä¸ªåœ°å€ç”¨äºå¤‡ä»½
FAKEROOT_SITE = https://snapshot.debian.org/archive/debian/20230724T160429Z/pool/main/f/fakeroot

FAKEROOT_AUTORECONF = YES

# ä¾èµ–é¡¹
HOST_FAKEROOT_DEPENDENCIES = host-acl host-gettext host-pkgconf

# ç¦ç”¨ capability
HOST_FAKEROOT_CONF_ENV = \
	ac_cv_header_sys_capability_h=no \
	ac_cv_func_capset=no

FAKEROOT_LICENSE = GPL-3.0+
FAKEROOT_LICENSE_FILES = COPYING

HOST_FAKEROOT_CONF_ENV += CFLAGS="$(HOST_CFLAGS) -fcommon"

# --- å…³é”®ä¿®å¤å¼€å§‹ ---
# å®šä¹‰ä¸€ä¸ªé’©å­ï¼šåœ¨æ‰“è¡¥ä¸ä¹‹åã€é…ç½®ä¹‹å‰ï¼Œå¼ºè¡ŒæŠŠ configure.ac é‡Œçš„ 2.71 æ”¹æˆ 2.69
# è¿™æ ·æ—§ç‰ˆ Buildroot çš„ Autoconf å°±èƒ½é€šè¿‡æ£€æŸ¥äº†
define HOST_FAKEROOT_FIX_AUTOCONF_VERSION
	$(SED) 's/2\.71/2.69/g' $(@D)/configure.ac
endef

# å°†è¿™ä¸ªé’©å­æ³¨å†Œåˆ° host-fakeroot çš„æ„å»ºæµç¨‹ä¸­
HOST_FAKEROOT_POST_PATCH_HOOKS += HOST_FAKEROOT_FIX_AUTOCONF_VERSION
# --- å…³é”®ä¿®å¤ç»“æŸ ---

$(eval $(host-autotools-package))




åˆ é™¤æ—§ Hashï¼š
rm buildroot/package/fakeroot/fakeroot.hash

æ—§çš„è¡¥ä¸æ–‡ä»¶æ‰“åœ¨æ–°çš„ 1.32.1 æºç ä¸Šè‚¯å®šä¼šæŠ¥é”™ï¼ˆApply failedï¼‰ï¼Œå¯¼è‡´ç¼–è¯‘åœæ­¢ã€‚
# è¿›å…¥ Buildroot ç›®å½•
cd /home/wzp/BSP/rk356x_linux/buildroot

# åˆ é™¤ fakeroot ç›®å½•ä¸‹çš„æ‰€æœ‰è¡¥ä¸æ–‡ä»¶
rm -f package/fakeroot/*.patch

# å†æ¬¡ç¡®è®¤æ¸…ç†äº†æ—§çš„ç¼–è¯‘ç¼“å­˜
rm -rf output/rockchip_rk356x_recovery/build/host-fakeroot-*


#ä¸‹è½½fakeroot_1.32.1
mkdir -p /home/wzp/BSP/rk356x_linux/buildroot/dl
cd /home/wzp/BSP/rk356x_linux/buildroot/dl

# ä½¿ç”¨ Buildroot å®˜æ–¹å¤‡ä»½æºä¸‹è½½ (é€Ÿåº¦å¿«ä¸”ç¨³å®š)
wget https://sources.buildroot.net/fakeroot/fakeroot_1.32.1.orig.tar.gz


recoveryç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼š

é—®é¢˜ä¸€ï¼š
2025-12-31T21:26:53 >>> host-m4 1.4.18 Building
Done in 43s  (error code: 2)
Command exited with non-zero status 2
you take 0:42.65 to build recovery
ERROR: Running build_recovery failed!
ERROR: exit code 2 from line 563:
/usr/bin/time -f "you take %E to build recovery" $COMMON_DIR/mk-ramdisk.sh recovery.img $RK_CFG_RECOVERY

è¿™æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„ Glibc ç‰ˆæœ¬ä¸å…¼å®¹ é—®é¢˜ã€‚
æ‰¾åˆ°æŠ¥é”™çš„æºæ–‡ä»¶ï¼š
æ ¹æ®ä½ çš„æ—¥å¿—è·¯å¾„ï¼Œæ–‡ä»¶åº”è¯¥ä½äºï¼š
/home/wzp/BSP/rk356x_linux/buildroot/output/rockchip_rk356x_recovery/build/host-m4-1.4.18/lib/c-stack.c
é—®é¢˜åŸå› ï¼š
è¯·çœ‹ä½ æ–‡ä»¶ä¸­çš„ ç¬¬ 132 è¡Œï¼š
char buffer[SIGSTKSZ];
è¿™é‡Œçš„ SIGSTKSZ ç”¨æ¥å®šä¹‰ä¸€ä¸ªé™æ€è”åˆä½“ï¼ˆunionï¼‰ä¸­æ•°ç»„çš„å¤§å°ã€‚åœ¨ä»¥å‰çš„ Linux ç³»ç»Ÿä¸­ï¼ŒSIGSTKSZ æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼ˆé€šå¸¸æ˜¯ 8192ï¼‰ã€‚ä½†åœ¨è¾ƒæ–°çš„ Ubuntuï¼ˆå¦‚ 22.04+ï¼‰ä¸­ï¼ŒSIGSTKSZ å˜æˆäº†ä¸€ä¸ªè¿è¡Œæ—¶å˜é‡ï¼ˆsysconf è°ƒç”¨ï¼‰ï¼Œå¯¼è‡´ç¼–è¯‘å™¨æŠ¥é”™ï¼šâ€œæ— æ³•åœ¨æ–‡ä»¶ä½œç”¨åŸŸä½¿ç”¨å˜é•¿æ•°ç»„â€ã€‚

è§£å†³æ–¹æ³•ï¼š
#ifndef SIGSTKSZ
# define SIGSTKSZ 16384
#elif HAVE_LIBSIGSEGV && SIGSTKSZ < 16384
/* libsigsegv 2.6 through 2.8 have a bug where some architectures use
   more than the Linux default of an 8k alternate stack when deciding
   if a fault was caused by stack overflow.  */
# undef SIGSTKSZ
# define SIGSTKSZ 16384
#endif

æ”¹æˆï¼š

#if ! HAVE_STACK_T && ! defined stack_t
typedef struct sigaltstack stack_t;
#endif

/* ä¿®å¤ host-m4 åœ¨æ–°ç‰ˆ glibc ç¼–è¯‘æŠ¥é”™çš„é—®é¢˜ */
#ifdef SIGSTKSZ
# undef SIGSTKSZ
#endif
#define SIGSTKSZ 16384

#include <stdlib.h>
#include <string.h>

4. ä¿å­˜å¹¶é‡æ–°ç¼–è¯‘
ä¿å­˜æ–‡ä»¶åï¼Œå›åˆ°ç»ˆç«¯ï¼Œç›´æ¥å†æ¬¡è¿è¡Œç¼–è¯‘å‘½ä»¤å³å¯ï¼ˆä¸éœ€è¦ cleanï¼Œç›´æ¥ç»§ç»­ç¼–è¯‘ï¼‰ï¼š
./build.sh recovery


é—®é¢˜äºŒï¼š
2025-12-31T22:05:15 >>> host-fakeroot 1.20.2 Building
Done in 14min 34s  (error code: 2)
Command exited with non-zero status 2
you take 14:34.59 to build recovery
ERROR: Running build_recovery failed!
ERROR: exit code 2 from line 563:
/usr/bin/time -f "you take %E to build recovery" $COMMON_DIR/mk-ramdisk.sh recovery.img $RK_CFG_RECOVERY


é—®é¢˜åœ¨äºUbuntu ç³»ç»Ÿï¼ˆHostï¼‰ä½¿ç”¨äº†è¾ƒæ–°çš„ Glibc åº“ï¼Œè€Œè¿™ä¸ªè€ç‰ˆæœ¬çš„ fakeroot æºç ä¾èµ–äºä¸€ä¸ªå·²ç»è¢« Glibc ç§»é™¤çš„å® _STAT_VERã€‚
ä½ éœ€è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨ ç¬¬ 124 è¡Œ å·¦å³çš„ä½ç½®æ’å…¥ä¸€æ®µè¡¥ä¸ä»£ç ã€‚
ä¿®æ”¹æ­¥éª¤
1. æ‰“å¼€æ–‡ä»¶
æ–‡ä»¶è·¯å¾„ï¼ˆæ ¹æ®ä½ ä¹‹å‰çš„æ—¥å¿—ï¼‰ï¼š
/home/wzp/BSP/rk356x_linux/buildroot/output/rockchip_rk356x_recovery/build/host-fakeroot-1.20.2/libfakeroot.c
2. æ‰¾åˆ°å®šä½ç‚¹
è¯·æ‰¾åˆ° ç¬¬ 124 è¡Œ å·¦å³çš„ #include <sys/types.h>ã€‚
åŸæ–‡å†…å®¹ï¼ˆå¤§çº¦ 120-126 è¡Œï¼‰ï¼š

#include <unistd.h>
#include <dirent.h>
#include <errno.h>
#include <sys/types.h>
#ifdef HAVE_SYS_ACL_H
#include <sys/acl.h>

æ”¹æˆï¼š

#include <unistd.h>
#include <dirent.h>
#include <errno.h>
#include <sys/types.h>

/* --- FIX START: ä¿®å¤æ–°ç‰ˆ Ubuntu/Glibc ç¼–è¯‘æŠ¥é”™ --- */
#include <sys/stat.h>
#ifndef _STAT_VER
 #if defined (__aarch64__)
  #define _STAT_VER 0
 #elif defined (__x86_64__)
  #define _STAT_VER 1
 #else
  #define _STAT_VER 3
 #endif
#endif
/* --- FIX END --- */

#ifdef HAVE_SYS_ACL_H
#include <sys/acl.h>
#endif /* HAVE_SYS_ACL_H */
5. ä¿å­˜å¹¶ç»§ç»­ç¼–è¯‘
ä¿å­˜æ–‡ä»¶åï¼Œä¸éœ€è¦æ‰§è¡Œ clean æ“ä½œï¼Œç›´æ¥å›åˆ°ç»ˆç«¯è¿è¡Œç¼–è¯‘å‘½ä»¤å³å¯ï¼Œå®ƒä¼šæ¥ç€åˆšæ‰çš„åœ°æ–¹ç»§ç»­ç¼–è¯‘ï¼š

./build.sh recovery


é—®é¢˜ä¸‰ï¼š
2026-01-01T01:38:39 >>> host-squashfs 3de1687d7432ea9b302c2db9521996f506c140a3 Building
Done in 37s  (error code: 2)
Command exited with non-zero status 2
you take 0:37.52 to build recovery
ERROR: Running build_recovery failed!
ERROR: exit code 2 from line 563:
/usr/bin/time -f "you take %E to build recovery" $COMMON_DIR/mk-ramdisk.sh recovery.img $RK_CFG_RECOVERY


cd /home/wzp/BSP/rk356x_linux/buildroot/output/rockchip_rk356x_recovery/build/host-squashfs-3de1687d7432ea9b302c2db9521996f506c140a3/squashfs-tools

Makefileé‡Œ
CFLAGS ?= -O2
CFLAGS += $(EXTRA_CFLAGS) $(INCLUDEDIR) -D_FILE_OFFSET_BITS=64 \
	-D_LARGEFILE_SOURCE -D_GNU_SOURCE -DCOMP_DEFAULT=\"$(COMP_DEFAULT)\" \
	-Wall
å°†å…¶ä¿®æ”¹ä¸ºï¼ˆæ·»åŠ äº†ä¸€è¡Œ CFLAGS += -fcommonï¼‰ï¼š

CFLAGS ?= -O2
CFLAGS += -fcommon
CFLAGS += $(EXTRA_CFLAGS) $(INCLUDEDIR) -D_FILE_OFFSET_BITS=64 \
	-D_LARGEFILE_SOURCE -D_GNU_SOURCE -DCOMP_DEFAULT=\"$(COMP_DEFAULT)\" \
	-Wall

mksquashfs.c/unsquashfs.c/acton.c/info.c/process_fragments.c/persudo.c/read_.c/resore.c/sort.c/mksquashfs_info.c/xattr.cï¼šåœ¨ #include <sys/types.h> åæ·»åŠ  #include <sys/sysmacros.h>


æˆ–è€…. è¿›å…¥æºç ç›®å½•
cd /home/wzp/BSP/rk356x_linux/buildroot/output/rockchip_rk356x_recovery/build/host-squashfs-3de1687d7432ea9b302c2db9521996f506c140a3/squashfs-tools
2. æ ¸å¿ƒä¿®å¤ï¼šä¿®æ”¹ squashfs_fs.h
æˆ‘ä»¬åœ¨è¯¥æ–‡ä»¶å¼€å¤´æ’å…¥ #include <sys/sysmacros.h>ï¼Œè¿™æ ·æ‰€æœ‰æºæ–‡ä»¶éƒ½èƒ½ç”Ÿæ•ˆã€‚
# ä½¿ç”¨ sed å‘½ä»¤ä¸€é”®æ’å…¥ï¼ˆæ¯”æ‰‹åŠ¨æ‰“å¼€ç¼–è¾‘å™¨æ›´ç¨³ï¼‰
sed -i '1i#include <sys/sysmacros.h>' squashfs_fs.h

ä¹‹å‰æ”¹è¿‡ï¼Œä½†ä¸ºäº†ç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œè¯·æ£€æŸ¥æˆ–å†æ¬¡æ‰§è¡Œï¼š
# æ‰¾åˆ° CFLAGS å¹¶è¿½åŠ  -fcommon
sed -i 's/CFLAGS ?= -O2/CFLAGS ?= -O2 -fcommon/' Makefile
(æˆ–è€…å¯ä»¥åƒä¹‹å‰ä¸€æ ·æ‰‹åŠ¨æ‰“å¼€ Makefile ç¡®è®¤ CFLAGS é‡Œæœ‰ -fcommon)
4. å…³é”®æ­¥éª¤ï¼šæ¸…ç†æ—§çš„ç¼–è¯‘ä¸­é—´æ–‡ä»¶
å› ä¸ºä¹‹å‰æ”¹äº†å¾ˆå¤šæ–‡ä»¶åˆå¤±è´¥äº†ï¼Œå¯èƒ½æ®‹ç•™äº†ä¸€äº›é”™è¯¯çš„ .o ç›®æ ‡æ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬åˆ æ‰ï¼Œè§¦å‘é‡æ–°ç¼–è¯‘ï¼ˆä½†ä¸è¦åˆ æºç ç›®å½•ï¼‰ã€‚
# åˆ é™¤æ‰€æœ‰ç¼–è¯‘ç”Ÿæˆçš„ .o æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶
rm -f *.o mksquashfs unsquashfs


é—®é¢˜ä¸€åˆ°ä¸‰å¯åœ¨å¿«æ·é”®txtä¸­å¿«é€Ÿè§£å†³

é—®é¢˜å››ï¼Œbuildrootä¸­ï¼š
2026-01-01T02:52:13 make[1]: *** [package/pkg-generic.mk:231: /home/wzp/BSP/rk356x_linux/buildroot/output/rockchip_rk3568/build/host-perl-5.26.1/.stamp_built] Error 2
2026-01-01T02:52:13 make: *** [/home/wzp/BSP/rk356x_linux/buildroot/output/rockchip_rk3568/Makefile:16: _all] Error 2
Command exited with non-zero status 1
you take 38:38.81 to build builroot
ERROR: Running build_buildroot failed!
ERROR: exit code 1 from line 412:
    /usr/bin/time -f "you take %E to build builroot" $COMMON_DIR/mk-buildroot.sh $BOARD_CONFIG


package/perl/perl.mkä¿®æ”¹æˆå¦‚ä¸‹ï¼š
################################################################################
#
# perl
#
################################################################################

# When updating the version here, also update utils/scancpan
# ä¿®æ”¹ 1: å‡çº§ Perl åˆ° 5.38.2
PERL_VERSION_MAJOR = 38
PERL_VERSION = 5.$(PERL_VERSION_MAJOR).2
PERL_SITE = http://www.cpan.org/src/5.0
PERL_SOURCE = perl-$(PERL_VERSION).tar.xz
PERL_LICENSE = Artistic or GPL-1.0+
PERL_LICENSE_FILES = Artistic Copying README
PERL_INSTALL_STAGING = YES

# ä¿®æ”¹ 2: å‡çº§ perl-cross åˆ° 1.6 (å¿…é¡»å‡çº§ï¼Œå¦åˆ™æ— æ³•ç¼–è¯‘ 5.38)
PERL_CROSS_VERSION = 1.6
# DO NOT refactor with the github helper (the result is not the same)
PERL_CROSS_SITE = https://github.com/arsv/perl-cross/releases/download/$(PERL_CROSS_VERSION)
PERL_CROSS_SOURCE = perl-cross-$(PERL_CROSS_VERSION).tar.gz
PERL_EXTRA_DOWNLOADS = $(PERL_CROSS_SITE)/$(PERL_CROSS_SOURCE)

# We use the perlcross hack to cross-compile perl. It should
# be extracted over the perl sources, so we don't define that
# as a separate package. Instead, it is downloaded and extracted
# together with perl
define PERL_CROSS_EXTRACT
	$(call suitable-extractor,$(PERL_CROSS_SOURCE)) $(DL_DIR)/$(PERL_CROSS_SOURCE) | \
	$(TAR) --strip-components=1 -C $(@D) $(TAR_OPTIONS) -
endef
PERL_POST_EXTRACT_HOOKS += PERL_CROSS_EXTRACT

# Even though perl is not an autotools-package, it uses config.sub and
# config.guess. Up-to-date versions of these files may be needed to build perl
# on newer host architectures, so we borrow the hook which updates them from the
# autotools infrastructure.
PERL_POST_PATCH_HOOKS += UPDATE_CONFIG_HOOK

ifeq ($(BR2_PACKAGE_BERKELEYDB),y)
PERL_DEPENDENCIES += berkeleydb
endif
ifeq ($(BR2_PACKAGE_GDBM),y)
PERL_DEPENDENCIES += gdbm
endif

# We have to override LD, because an external multilib toolchain ld is not
# wrapped to provide the required sysroot options.
PERL_CONF_OPTS = \
	--target=$(GNU_TARGET_NAME) \
	--target-tools-prefix=$(TARGET_CROSS) \
	--prefix=/usr \
	-Dld="$(TARGET_CC)" \
	-Dccflags="$(TARGET_CFLAGS)" \
	-Dldflags="$(TARGET_LDFLAGS) -lm" \
	-Dmydomain="" \
	-Dmyhostname="noname" \
	-Dmyuname="Buildroot $(BR2_VERSION_FULL)" \
	-Dosname=linux \
	-Dosvers=$(LINUX_VERSION) \
	-Dperladmin=root

ifeq ($(shell expr $(PERL_VERSION_MAJOR) % 2), 1)
PERL_CONF_OPTS += -Dusedevel
endif

ifeq ($(BR2_STATIC_LIBS),y)
PERL_CONF_OPTS += --all-static --no-dynaloader
endif

PERL_MODULES = $(call qstrip,$(BR2_PACKAGE_PERL_MODULES))
ifneq ($(PERL_MODULES),)
PERL_CONF_OPTS += --only-mod=$(subst $(space),$(comma),$(PERL_MODULES))
endif

define PERL_CONFIGURE_CMDS
	(cd $(@D); $(TARGET_MAKE_ENV) HOSTCC='$(HOSTCC_NOCCACHE)' \
		./configure $(PERL_CONF_OPTS))
	$(SED) 's/UNKNOWN-/Buildroot $(BR2_VERSION_FULL) /' $(@D)/patchlevel.h
endef

define PERL_BUILD_CMDS
	$(TARGET_MAKE_ENV) $(MAKE1) -C $(@D) all
endef

define PERL_INSTALL_STAGING_CMDS
	$(TARGET_MAKE_ENV) $(MAKE1) -C $(@D) DESTDIR="$(STAGING_DIR)" install.perl install.sym
endef

define PERL_INSTALL_TARGET_CMDS
	$(TARGET_MAKE_ENV) $(MAKE1) -C $(@D) DESTDIR="$(TARGET_DIR)" install.perl install.sym
endef

# ä¿®æ”¹ 3: å¢åŠ  -fno-stack-protector å’Œ -O2ï¼Œä¿®å¤ host-perl åœ¨ Ubuntu 22.04 ä¸‹çš„ Segfault
HOST_PERL_CONF_OPTS = \
	-des \
	-Dprefix="$(HOST_DIR)" \
	-Dcc="$(HOSTCC)" \
	-Doptimize="-O2" \
	-Accflags="-fno-stack-protector"

define HOST_PERL_CONFIGURE_CMDS
	(cd $(@D); $(HOST_MAKE_ENV) HOSTCC='$(HOSTCC_NOCCACHE)' \
		./Configure $(HOST_PERL_CONF_OPTS))
endef

define HOST_PERL_BUILD_CMDS
	$(HOST_MAKE_ENV) $(MAKE) -C $(@D)
endef

define HOST_PERL_INSTALL_CMDS
	$(HOST_MAKE_ENV) $(MAKE) -C $(@D) INSTALL_DEPENDENCE='' install
endef

$(eval $(generic-package))
$(eval $(host-generic-package))

define PERL_FINALIZE_TARGET
	rm -rf $(TARGET_DIR)/usr/lib/perl5/$(PERL_VERSION)/pod
	rm -rf $(TARGET_DIR)/usr/lib/perl5/$(PERL_VERSION)/$(PERL_ARCHNAME)/CORE
	find $(TARGET_DIR)/usr/lib/perl5/ -name 'extralibs.ld' -print0 | xargs -0 rm -f
	find $(TARGET_DIR)/usr/lib/perl5/ -name '*.bs' -print0 | xargs -0 rm -f
	find $(TARGET_DIR)/usr/lib/perl5/ -name '.packlist' -print0 | xargs -0 rm -f
endef
PERL_TARGET_FINALIZE_HOOKS += PERL_FINALIZE_TARGET


åœ¨å†æ¬¡è¿è¡Œç¼–è¯‘ä¹‹å‰ï¼Œè¯·åŠ¡å¿…æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¦åˆ™ä¼šå› ä¸ºæ—§è¡¥ä¸ä¸å…¼å®¹è€Œç«‹åˆ»æŠ¥é”™ï¼š
#åˆ é™¤æ—§è¡¥ä¸æ–‡ä»¶ï¼ˆBuildroot ç›®å½•ä¸‹ï¼‰ï¼š
rm -f package/perl/*.patch
#åˆ é™¤æ—§çš„ Hash æ–‡ä»¶ï¼ˆBuildroot ä¼šæ ¡éªŒå¤±è´¥ï¼‰ï¼š
rm -f package/perl/perl.hash
#æ¸…ç†æ„å»ºç›®å½•ï¼š
rm -rf output/rockchip_rk3568/build/host-perl-*
rm -rf output/rockchip_rk3568/build/perl-*
#ç»§ç»­ç¼–è¯‘
cd /home/wzp/BSP/rk356x_linux
./build.sh buildroot


æœ€ç»ˆé—®é¢˜ï¼š
çƒ§å½•å®Œæˆåçš„é¡µé¢åœåœ¨å¼€æœº+kernelçš„logo
è§£å†³æ–¹æ³•ï¼š
åœ¨sdkç›®å½•ä¸‹è¿›è¡Œï¼š
# æœç´¢åä¸º S50weston æˆ– S50launcher çš„æ–‡ä»¶ï¼š
find . -name "S50weston" -o -name "S50launcher

å¦‚ä¸‹ï¼š
wzp@ubuntu:~/BSP/rk356x_linux$ # æœç´¢åä¸º S50weston æˆ– S50launcher çš„æ–‡ä»¶
find . -name "S50weston" -o -name "S50launcher"
./app/QLauncher/S50launcher
./buildroot/output/rockchip_rk3568/build/QLauncher-1.0/S50launcher
./buildroot/output/rockchip_rk3568/target/etc/init.d/S50launcher


éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ˜¯ï¼š./app/QLauncher/S50launcher

å°†å…¶ä¿®æ”¹ä¸º
...
  start)
		printf "Starting launcher: "
		export LC_ALL='zh_CN.utf8'

		# Uncomment to disable mirror mode
		# unset WESTON_DRM_MIRROR

		# --- FIX START: ä¿®å¤ /var/run æƒé™ä¸º 0700 ---
		# Weston å¼ºåˆ¶è¦æ±‚ XDG_RUNTIME_DIR ç›®å½•æƒé™å¿…é¡»æ˜¯ 0700ï¼Œå¦åˆ™æ‹’ç»å¯åŠ¨
		if [ ! -d "/var/run" ]; then
			mkdir -p /var/run
		fi
		chmod 0700 /var/run
		# --- FIX END ---

		export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/var/run}
		export QT_QPA_PLATFORM=${QT_QPA_PLATFORM:-wayland}
...


 å¦‚æœå‘ç°æ–‡ä»¶æ²¡æœ‰å˜æ€ä¹ˆåŠï¼Ÿ
Buildroot æœ‰æ—¶å€™ä¼šå› ä¸ºâ€œå¢é‡ç¼–è¯‘â€æœºåˆ¶åˆ¤æ–­å¤±è¯¯ï¼Œè§‰å¾— app/QLauncher æ²¡æœ‰å˜åŒ–å°±ä¸é‡æ–°å®‰è£…å®ƒï¼Œè¯·æ‰§è¡Œä¸‹é¢çš„å¼ºåˆ¶æ›´æ–°å‘½ä»¤ï¼š
# 1. å¼ºåˆ¶æ¸…ç† QLauncher çš„ç¼–è¯‘çŠ¶æ€
rm -rf buildroot/output/rockchip_rk3568/build/QLauncher-*

# 2. å†æ¬¡è¿è¡Œç¼–è¯‘
./build.sh buildroot

# 3. å†æ¬¡æ£€æŸ¥
grep "chmod 0700" buildroot/output/rockchip_rk3568/target/etc/init.d/S50launcher

æ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼ŒæŸ¥çœ‹outputæ–‡ä»¶é‡Œæ˜¯å¦åŒ…å«ä½ åŠ çš„ chmod 0700 ä»£ç ï¼š
cat buildroot/output/rockchip_rk3568/target/etc/init.d/S50launcher